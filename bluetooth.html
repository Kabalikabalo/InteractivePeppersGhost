<script>
const NUS_UUID = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';

let device, server, nusService, writableChar;

async function pickDevice() {
  device = await navigator.bluetooth.requestDevice({
    filters: [{ namePrefix: 'BBC micro:bit' }, { namePrefix: 'micro:bit' }],
    optionalServices: [NUS_UUID]
  });
  device.addEventListener('gattserverdisconnected', ()=>console.log('Disconnected'));
}

async function connectAndFindWritable() {
  server = await device.gatt.connect();
  nusService = await server.getPrimaryService(NUS_UUID);

  const chars = await nusService.getCharacteristics();
  // Find any characteristic that supports write or writeWithoutResponse
  writableChar = chars.find(c => c.properties.write || c.properties.writeWithoutResponse);

  if (!writableChar) {
    const list = await Promise.all(chars.map(async c => {
      const p = c.properties;
      return `${c.uuid} -> write:${!!p.write} wwr:${!!p.writeWithoutResponse} notify:${!!p.notify}`;
    }));
    throw new Error('No writable characteristic found.\n' + list.join('\n'));
  }

  console.log('Using writable char:', writableChar.uuid, writableChar.properties);
}

async function sendLine(text) {
  if (!writableChar) throw new Error('Not connected');
  const data = new TextEncoder().encode(text);
  if (writableChar.properties.writeWithoutResponse && writableChar.writeValueWithoutResponse) {
    await writableChar.writeValueWithoutResponse(data);
  } else {
    await writableChar.writeValue(data);
  }
}

async function connectAndSendOnce() {
  await pickDevice();
  await connectAndFindWritable();
  await new Promise(r => setTimeout(r, 200));
  await sendLine('42\n');
  alert('Sent 42!');
}
</script>
<button onclick="connectAndSendOnce()">Connect & Send 42</button>
