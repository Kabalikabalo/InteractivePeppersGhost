<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>micro:bit UART — Send Number</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>body{font-family:system-ui,sans-serif;margin:16px} input,button{font-size:1rem}</style>
</head>
<body>
  <h1>Send a Number to micro:bit</h1>

  <button id="connect">Connect</button>

  <div style="margin-top:1rem;">
    <input id="num" type="number" min="-9999" max="9999" value="42" />
    <button id="send">Send</button>
  </div>

  <p id="status">Not connected.</p>

  <script>
    const NUS_UUID = '6e400001-b5a3-f393-e0a9-e50e24dcca9e'; // Nordic UART Service

    let device, server, nusService, writableChar;

    function setStatus(s){ document.getElementById('status').textContent = s; }

    async function pickDevice() {
      device = await navigator.bluetooth.requestDevice({
        filters: [{ namePrefix: 'BBC micro:bit' }, { namePrefix: 'micro:bit' }],
        optionalServices: [NUS_UUID]
      });
      device.addEventListener('gattserverdisconnected', () => {
        writableChar = null;
        setStatus('Disconnected.');
      });
    }

    async function connectAndFindWritable() {
      server = await device.gatt.connect();
      const svc = await server.getPrimaryService(NUS_UUID);
      const chars = await svc.getCharacteristics();
      // Auto-pick any char that supports write
      writableChar = chars.find(c => c.properties.write || c.properties.writeWithoutResponse);
      if (!writableChar) {
        const list = await Promise.all(chars.map(async c => {
          const p = c.properties;
          return `${c.uuid} -> write:${!!p.write} wwr:${!!p.writeWithoutResponse} notify:${!!p.notify}`;
        }));
        throw new Error('No writable characteristic found:\n' + list.join('\n'));
      }
      setStatus('Connected. Using char: ' + writableChar.uuid);
    }

    async function sendLine(text) {
      if (!writableChar || !device?.gatt?.connected) throw new Error('Not connected');
      const data = new TextEncoder().encode(text);
      if (writableChar.properties.writeWithoutResponse && writableChar.writeValueWithoutResponse) {
        await writableChar.writeValueWithoutResponse(data);
      } else {
        await writableChar.writeValue(data);
      }
    }

    document.getElementById('connect').addEventListener('click', async () => {
      if (!('bluetooth' in navigator)) { alert('Web Bluetooth not supported'); return; }
      try {
        await pickDevice();
        await connectAndFindWritable();
      } catch (e) {
        console.error(e);
        alert(e.message || e);
      }
    });

    document.getElementById('send').addEventListener('click', async () => {
      try {
        let n = document.getElementById('num').value;
        // clamp to 0–180 if you want, or just send raw
        // n = Math.max(0, Math.min(180, Number(n)|0));
        await sendLine(String(n) + '\n'); // newline so micro:bit's uartReadUntil("\n") triggers
        setStatus('Sent: ' + n);
      } catch (e) {
        console.error(e);
        alert('Send failed: ' + (e.message || e));
      }
    });

    // Press Enter in the input to send
    document.getElementById('num').addEventListener('keydown', e => {
      if (e.key === 'Enter') document.getElementById('send').click();
    });
  </script>
</body>
</html>
